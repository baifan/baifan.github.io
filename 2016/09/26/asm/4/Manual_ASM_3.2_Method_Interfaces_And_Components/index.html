
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>3.2 ASM-方法-接口和组件 | BaiFan</title>
    <meta name="description" id="description" content="3.2 ASM-方法-接口和组件 | BaiFan" />
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="BaiFan">
    

    
    <meta name="description" content="ASM-方法-接口和组件">
<meta property="og:type" content="article">
<meta property="og:title" content="3.2 ASM-方法-接口和组件">
<meta property="og:url" content="http://www.innereye.cn/2016/09/26/asm/4/Manual_ASM_3.2_Method_Interfaces_And_Components/index.html">
<meta property="og:site_name" content="BaiFan">
<meta property="og:description" content="ASM-方法-接口和组件">
<meta property="og:image" content="http://www.innereye.cn/img/program/asm/ASM-3.2.3-48-3.5.png">
<meta property="og:image" content="http://www.innereye.cn/img/program/asm/ASM-3.2.5-56-3.6.png">
<meta property="og:updated_time" content="2016-09-29T14:41:32.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="3.2 ASM-方法-接口和组件">
<meta name="twitter:description" content="ASM-方法-接口和组件">
<meta name="twitter:image" content="http://www.innereye.cn/img/program/asm/ASM-3.2.3-48-3.5.png">

    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		

    <div style="float: left;display: none;">
    <img src="/img/logo.big.png" alt="BaiFan" title="BaiFan"/>
    </div>
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="BaiFan" title="BaiFan"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="BaiFan">BaiFan</a></h1>
				<h2 class="blog-motto">Make it work, Make it right, Make it fast.</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home | 首页</a></li>
					
						<li><a href="/archives">Archives | 归档</a></li>
					
						<li><a href="/categories">Categories | 分类</a></li>
					
						<li><a href="/tags">Tags | 标签</a></li>
					
						<li><a href="/about">About | 关于我</a></li>
					
					<li>
 					
						<form class="search"  accept-charset="utf-8">
							<label>Search</label>
							<input type="text" id="search" class="st-default-search-input" maxlength="20"
								   placeholder="Search"/>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/09/26/asm/4/Manual_ASM_3.2_Method_Interfaces_And_Components/" title="3.2 ASM-方法-接口和组件" itemprop="url">3.2 ASM-方法-接口和组件</a>
  </h1>
  <p class="article-declaration">本文可转载演绎，但需要注明原作者和本文链接。</p>
  <p class="article-author">By
       
		<a href="/about" title="BaiFan" target="_blank" itemprop="author">BaiFan</a>
		
    </p>
  <p class="article-time">
    <time datetime="2016-09-26T13:25:13.000Z" itemprop="datePublished"> 发表于 2016-09-26</time>
   </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-接口和组件"><span class="toc-number">1.</span> <span class="toc-text">3.2 接口和组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-介绍"><span class="toc-number">1.1.</span> <span class="toc-text">3.2.1 介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-生成方法-Generating-methods"><span class="toc-number">1.2.</span> <span class="toc-text">3.2.2 生成方法 Generating methods</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-3-改造方法-Transforming-methods"><span class="toc-number">1.3.</span> <span class="toc-text">3.2.3. 改造方法 Transforming methods</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-4-无状态转换-Stateless-transformations"><span class="toc-number">1.4.</span> <span class="toc-text">3.2.4 无状态转换 Stateless transformations</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-5-有状态转换-Statefull-transformations"><span class="toc-number">1.5.</span> <span class="toc-text">3.2.5. 有状态转换 Statefull transformations</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#标签和帧：Labels-and-frames"><span class="toc-number">1.5.1.</span> <span class="toc-text">标签和帧：Labels and frames</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#一个更加复杂的示例"><span class="toc-number">1.5.2.</span> <span class="toc-text">一个更加复杂的示例</span></a></li></ol></li></ol></li></ol>
		
		</div>
		
		<p>ASM-方法-接口和组件<br><a id="more"></a></p>
<h3 id="3-2-接口和组件"><a href="#3-2-接口和组件" class="headerlink" title="3.2 接口和组件"></a>3.2 接口和组件</h3><h4 id="3-2-1-介绍"><a href="#3-2-1-介绍" class="headerlink" title="3.2.1 介绍"></a>3.2.1 介绍</h4><p>在ASM API中，用来生成和转变编译后方法的都是基于<strong>‘MethodVisitor’</strong>抽象类的（参照图表 3.4），这是由<strong>‘ClassVisitor’</strong>的<strong>‘visitMethod’</strong>方法返回的。<br>除了一些注解和调试相关的信息（这些信息将在下一章说明），这个类定义了每个字节码指令类别一个方法，根据这些指令的参数数量和参数类型（这些类别不对应3.1.2节介绍的那些类别）。<br>这些方法必须按照以下顺序调用（和<strong>MethodVisitor</strong>接口在Javadoc中指定的一些额外约束）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">visitAnnotationDefault?</div><div class="line">( visitAnnotation | visitParameterAnnotation | visitAttribute )\*</div><div class="line">( visitCode</div><div class="line">( visitTryCatchBlock | visitLabel | visitFrame | visitXxx Insn | visitLocalVariable | visitLineNumber ) \*</div><div class="line">visitMaxs )?</div><div class="line">visitEnd</div></pre></td></tr></table></figure></p>
<p>这意味着，如有注释和属性的话，则必须先访问，后面是非抽象方法的字节码。<br>对于这些方法，这些代码必须按顺序访问，在唯一一个<strong>‘visitCode’</strong>方法调用和唯一一个<strong>‘visitMaxs’</strong>方法调用之间。</p>
<blockquote>
<p>代码 3.4.: MethodVisitor类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodVisitor</span> </span>&#123; <span class="comment">// public accessors ommited</span></div><div class="line">  MethodVisitor(<span class="keyword">int</span> api);</div><div class="line">  MethodVisitor(<span class="keyword">int</span> api, MethodVisitor mv);</div><div class="line">  <span class="function">AnnotationVisitor <span class="title">visitAnnotationDefault</span><span class="params">()</span></span>;</div><div class="line">  <span class="function">AnnotationVisitor <span class="title">visitAnnotation</span><span class="params">(String desc, <span class="keyword">boolean</span> visible)</span></span>;</div><div class="line">  <span class="function">AnnotationVisitor <span class="title">visitParameterAnnotation</span><span class="params">(<span class="keyword">int</span> parameter, String desc, <span class="keyword">boolean</span> visible)</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">visitAttribute</span><span class="params">(Attribute attr)</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">visitCode</span><span class="params">()</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">visitFrame</span><span class="params">(<span class="keyword">int</span> type, <span class="keyword">int</span> nLocal, Object[] local, <span class="keyword">int</span> nStack, Object[] stack)</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">visitInsn</span><span class="params">(<span class="keyword">int</span> opcode)</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">visitIntInsn</span><span class="params">(<span class="keyword">int</span> opcode, <span class="keyword">int</span> operand)</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">visitVarInsn</span><span class="params">(<span class="keyword">int</span> opcode, <span class="keyword">int</span> var)</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">visitTypeInsn</span><span class="params">(<span class="keyword">int</span> opcode, String desc)</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">visitFieldInsn</span><span class="params">(<span class="keyword">int</span> opc, String owner, String name, String desc)</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">visitMethodInsn</span><span class="params">(<span class="keyword">int</span> opc, String owner, String name, String desc)</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">visitInvokeDynamicInsn</span><span class="params">(String name, String desc, Handle bsm, Object... bsmArgs)</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">visitJumpInsn</span><span class="params">(<span class="keyword">int</span> opcode, Label label)</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">visitLabel</span><span class="params">(Label label)</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">visitLdcInsn</span><span class="params">(Object cst)</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">visitIincInsn</span><span class="params">(<span class="keyword">int</span> var, <span class="keyword">int</span> increment)</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">visitTableSwitchInsn</span><span class="params">(<span class="keyword">int</span> min, <span class="keyword">int</span> max, Label dflt, Label[] labels)</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">visitLookupSwitchInsn</span><span class="params">(Label dflt, <span class="keyword">int</span>[] keys, Label[] labels)</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">visitMultiANewArrayInsn</span><span class="params">(String desc, <span class="keyword">int</span> dims)</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">visitTryCatchBlock</span><span class="params">(Label start, Label end, Label handler, String type)</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">visitLocalVariable</span><span class="params">(String name, String desc, String signature, Label start, Label end, <span class="keyword">int</span> index)</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">visitLineNumber</span><span class="params">(<span class="keyword">int</span> line, Label start)</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">visitMaxs</span><span class="params">(<span class="keyword">int</span> maxStack, <span class="keyword">int</span> maxLocals)</span></span>;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">visitEnd</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>因此在一系列的事件中，<strong>‘visitCode’</strong>方法和<strong>‘visitMaxs’</strong>方法可以用于检测一个方法字节码的开始和结束。<br>和class一样，<strong>‘visitEnd’</strong>方法必须最后调用，并且用于检测在一系列事件中一个方法的结束。</p>
<p><strong>‘ClassVisitor’</strong>和<strong>‘MethodVisitor’</strong>类整合后可以用于生成一个完整的类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">ClassVisitor cv = ...;</div><div class="line">cv.visit(...);</div><div class="line">MethodVisitor mv1 = cv.visitMethod(..., <span class="string">"m1"</span>, ...);</div><div class="line">mv1.visitCode();</div><div class="line">mv1.visitInsn(...);</div><div class="line">...</div><div class="line">mv1.visitMaxs(...);</div><div class="line">mv1.visitEnd();</div><div class="line">MethodVisitor mv2 = cv.visitMethod(..., <span class="string">"m2"</span>, ...);</div><div class="line">mv2.visitCode();</div><div class="line">mv2.visitInsn(...);</div><div class="line">...</div><div class="line">mv2.visitMaxs(...);</div><div class="line">mv2.visitEnd();</div><div class="line">cv.visitEnd();</div></pre></td></tr></table></figure>
<p>需要注意的是，没有必要为了开始访问另外一个方法，而结束当前访问的方法。<br>实际上，<strong>‘MethodVisitor’</strong>实例间是完全独立的，可以用任何顺序调用（但必须在<strong>‘cv.visitEnd()’</strong>调用之前使用）:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">ClassVisitor cv = ...;</div><div class="line">cv.visit(...);</div><div class="line">MethodVisitor mv1 = cv.visitMethod(..., <span class="string">"m1"</span>, ...);</div><div class="line">mv1.visitCode();</div><div class="line">mv1.visitInsn(...);</div><div class="line">...</div><div class="line">MethodVisitor mv2 = cv.visitMethod(..., <span class="string">"m2"</span>, ...);</div><div class="line">mv2.visitCode();</div><div class="line">mv2.visitInsn(...);</div><div class="line">...</div><div class="line">mv1.visitMaxs(...);</div><div class="line">mv1.visitEnd();</div><div class="line">...</div><div class="line">mv2.visitMaxs(...);</div><div class="line">mv2.visitEnd();</div><div class="line">cv.visitEnd();</div></pre></td></tr></table></figure></p>
<p>ASM提供了三个基于<strong>MethodVisitor API</strong>的核心组件，用于生成和转换方法：</p>
<ol>
<li><strong>ClassReader</strong>类解析一个编译后的方法，并且通过传递<strong>ClassVisitor</strong>作为<strong>accept</strong>方法的参数获得的返回，调用<strong>MethodVisitor’</strong>相应的方法。</li>
<li><strong>ClassWriter</strong>的<strong>‘visitMethod’</strong>返回了<strong>MethodVisitor</strong>抽象类的一个实现，该实现可以直接用二进制的方式构建编译后的方法。</li>
<li><strong>MethodVisitor</strong>类可以传递所有调用它的方法给另一个<strong>MethodVisitor</strong>类。<strong>MethodVisitor</strong>类可以看作一个事件过滤器。</li>
</ol>
<p>第50页 50/154</p>
<p><strong>ClassWriter选项</strong><br>如3.1.5节所讲，计算一个方法的栈哈希帧不是一件简单的事情：你需要计算所有的帧，找到对应着跳转目标的帧，或者在无条件跳转后紧挨着的帧，并且最后还要压缩保留的帧。<br>同样的，计算本地变量和操作栈部分的大小看似容易，其实不然。<br>庆幸的是ASM可以帮你处理这些。<br>当你创建一个<strong>ClassWriter</strong>对象的时候，你可以指定自动计算这些：</p>
<ul>
<li>使用<strong>‘new ClassWriter(0)’</strong>构造函数，不会自动计算这些属性。你必须自己计算帧的大小、本地变量的大小和操作栈的大小。</li>
<li>使用<strong>‘new ClassWriter(ClassWriter.COMPUTE_MAXS)’</strong>构造函数，本地变量的大小和操作栈的大小会被自动计算。你仍然需要调用<strong>‘visitMax’</strong>方法，但是你可以传递任意参数：ASM会忽略这些参数，并重新计算它们的大小。使用该选项，你必须计算帧的大小。</li>
<li>使用<strong>‘new ClassWriter(ClassWriter.COMPUTE_FRAMES)’</strong>构造函数，所有的属性都会被自动计算。你不必调用<strong>‘visitFrame’</strong>方法，但你仍然需要调用<strong>‘visitMax’</strong>方法(ASM会忽略这些参数，并重新计算它们的大小)。</li>
</ul>
<p>使用这些选项非常方便，但有一定的性能损耗：<strong>‘COMPUTE_MAX’</strong>会使<strong>‘ClassWriter’</strong>慢10%，<strong>‘COMPUTE_FRAMES’</strong>选项会慢两倍。<br>这必须将程序自己计算的时间与开发人员自己计算的时间相比较：在特定的情况下往往有更方便、快速的算法来计算这些，跟在ASM中使用的算法相比，必须能够处理所有情况。</p>
<p>需要注意的是，如果开发人员自己计算帧的大小，可以让<strong>‘ClassWriter’</strong>来为你处理压算环节。<br>这种情况下，你紧紧需要调用<strong>‘visitFrame(F_NEW, nLocals, locals, nStack, stack)’</strong>去访问未被压缩的帧，<em>‘nLocals’**和</em>‘nStack’<strong>表示本地变量和操作栈的大小，*’locals’</strong>和<em>‘stack’*</em>是这些值相对应的数据类型数组（详情参考Javadoc）。</p>
<p>同样需要注意的是，为了自动计算帧，有时候需要还要计算两个给定class的公共的超类。<br>默认<strong>‘ClassWriter’</strong>会为它们计算，在<strong>‘getCommonSuperClass’</strong>方法中，通过加载两个class到JVM中，并通过反射API实现。<br>如果你生成了几个class文件，并且它们之间相互引用，这可能是会是一个问题，因为引用的class可能还不存在。<br>在这种情况下，你可以重写<strong>‘getCommonSuperClass’</strong>方法来解决这个问题。</p>
<h4 id="3-2-2-生成方法-Generating-methods"><a href="#3-2-2-生成方法-Generating-methods" class="headerlink" title="3.2.2 生成方法 Generating methods"></a>3.2.2 生成方法 Generating methods</h4><p>在3.1.3章中定义的<strong>‘getF’</strong>方法的字节码，可以通过下面的方法调用生成（mv是一个MethodVisitor对象）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mv.visitCode();</div><div class="line">mv.visitVarInsn(ALOAD, <span class="number">0</span>);</div><div class="line">mv.visitFieldInsn(GETFIELD, <span class="string">"pkg/Bean"</span>, <span class="string">"f"</span>, <span class="string">"I"</span>);</div><div class="line">mv.visitInsn(IRETURN);</div><div class="line">mv.visitMaxs(<span class="number">1</span>, <span class="number">1</span>);</div><div class="line">mv.visitEnd();</div></pre></td></tr></table></figure>
<p>第一个调用开启了字节码生成。紧跟着三个调用生成了这个方法的三条指令（如你所见，字节码和ASM API之间的映射非常简单明了）。<br><strong>‘visitMaxs’</strong>方法，必须在所有指令方法调用之后调用。<br>该方法用于指定本方法执行帧的本地变量区和操作栈大小。<br>如3.1.3节所见，本地变量区和操作栈的大小都是一个槽。<br>最后调用<strong>‘visitEnd’</strong>方法生成本方法。</p>
<p><strong>‘setF’</strong>方法和构造函数也可以使用相同的方法生成字节码。<br>一个更加有趣的示例是<strong>‘checkAndSetF’</strong>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">mv.visitCode();</div><div class="line">mv.visitVarInsn(ILOAD, <span class="number">1</span>);</div><div class="line">Label label = <span class="keyword">new</span> Label();</div><div class="line">mv.visitJumpInsn(IFLT, label);</div><div class="line">mv.visitVarInsn(ALOAD, <span class="number">0</span>);</div><div class="line">mv.visitVarInsn(ILOAD, <span class="number">1</span>);</div><div class="line">mv.visitFieldInsn(PUTFIELD, <span class="string">"pkg/Bean"</span>, <span class="string">"f"</span>, <span class="string">"I"</span>);</div><div class="line">Label end = <span class="keyword">new</span> Label();</div><div class="line">mv.visitJumpInsn(GOTO, end);</div><div class="line">mv.visitLabel(label);</div><div class="line">mv.visitFrame(F_SAME, <span class="number">0</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>);</div><div class="line">mv.visitTypeInsn(NEW, <span class="string">"java/lang/IllegalArgumentException"</span>);</div><div class="line">mv.visitInsn(DUP);</div><div class="line">mv.visitMethodInsn(INVOKESPECIAL,<span class="string">"java/lang/IllegalArgumentException"</span>, <span class="string">"&lt;init&gt;"</span>, <span class="string">"()V"</span>);</div><div class="line">mv.visitInsn(ATHROW);</div><div class="line">mv.visitLabel(end);</div><div class="line">mv.visitFrame(F_SAME, <span class="number">0</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>);</div><div class="line">mv.visitInsn(RETURN);</div><div class="line">mv.visitMaxs(<span class="number">2</span>, <span class="number">2</span>);</div><div class="line">mv.visitEnd();</div></pre></td></tr></table></figure>
<p>在<strong>‘visitCode’</strong>和<strong>‘visitEnd’</strong>方法调用之间，你可以看到与3.1.5节结束时展示的字节码所准确对应的方法调用：每个指令、标签和帧都对应一个方法调用（唯一的例外就是声明和构造<strong>‘labe’</strong>和<strong>‘end’</strong>标签）。</p>
<p><strong>备注</strong></p>
<blockquote>
<p>一个标签对象用于后面的需要该标签的指令。<br>例如<strong>‘end’</strong>标签用于<strong>‘RETURN’</strong>指令，并不是紧跟其后的被访问的帧，因为帧不是一个指令。<br>多个标签用于一个相同的指令是完全合法的，但一个标签只能仅仅用于一个指令。<br>换句话说，使用不同的标签连续调用<strong>‘visitLabel’</strong>方法是可以的，但在一个指令中的标签必须仅能被<strong>‘visitLabel’</strong>方法调用一次。<br>最后一个约束是标签是不能被共享的：每个方法必须有他们自己的标签。</p>
</blockquote>
<h4 id="3-2-3-改造方法-Transforming-methods"><a href="#3-2-3-改造方法-Transforming-methods" class="headerlink" title="3.2.3. 改造方法 Transforming methods"></a>3.2.3. 改造方法 Transforming methods</h4><p>现在可以猜到，可以像改造class一样改造方法，即通过使用一个方法适配器转发调用它的方法，并进行一些修改：通过改变参数可以用于修改单条指令，通过不转发收到的调用来移除一个指令，通过在收到的调用间插入方法来插入新的指令。<br><strong>‘MethodVisitor’</strong>类提供了一个这样的方法适配器，不做任何处理，仅仅转发它所收到的方法调用。</p>
<p>为了理解如何使用方法适配器，让我们来设计一个非常简单的适配器：移除方法内部的<strong>‘NOP’</strong>指令（移除这些指令不会出现任何问题，因为它们不做任何操作）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.objectweb.asm.Opcodes.ASM4;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.objectweb.asm.Opcodes.NOP;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.objectweb.asm.MethodVisitor;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoveNopAdapter</span> <span class="keyword">extends</span> <span class="title">MethodVisitor</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RemoveNopAdapter</span><span class="params">(MethodVisitor mv)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(ASM4, mv);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitInsn</span><span class="params">(<span class="keyword">int</span> opcode)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (opcode != NOP) &#123;</div><div class="line">            mv.visitInsn(opcode);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该适配器可以用在一个class适配器中，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.objectweb.asm.Opcodes.ASM4;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.objectweb.asm.ClassVisitor;</div><div class="line"><span class="keyword">import</span> org.objectweb.asm.MethodVisitor;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoveNopClassAdapter</span> <span class="keyword">extends</span> <span class="title">ClassVisitor</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RemoveNopClassAdapter</span><span class="params">(ClassVisitor cv)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(ASM4, cv);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> MethodVisitor <span class="title">visitMethod</span><span class="params">(<span class="keyword">int</span> access, String name,</span></span></div><div class="line">        String desc, String signature, String[] exceptions) &#123;</div><div class="line">        MethodVisitor mv;</div><div class="line">        mv = cv.visitMethod(access, name, desc, signature, exceptions);</div><div class="line">        <span class="keyword">if</span> (mv != <span class="keyword">null</span>) &#123;</div><div class="line">            mv = <span class="keyword">new</span> RemoveNopAdapter(mv);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> mv;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>换句话说，在链路中，类适配器(ClassAdapter)仅仅创建了一个方法适配器(MethodAdapter)，封装了下一个类访问器(ClassVisitor)返回的方法访问器(MethodVisitor)，并返回封装后的方法适配器。<br>其效果是一个方法适配链的构建，似于一个类适配链的构建（参考图表 3.5）。</p>
<p><img src="/img/program/asm/ASM-3.2.3-48-3.5.png" alt="图表 3.5 RemoveNopAdapter时序图"></p>
<p>但请注意，这并非是强制：可以完全构建一个不同于类适配链的方法适配链。<br>甚至每一个方法都有一个不同的方法适配链。<br>例如，类适配器可以选择只移除普通方法中的<strong>‘NOP’</strong>指令，而不移除构造函数中的。<br>实现的方式如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">mv = cv.visitMethod(access, name, desc, signature, exceptions);</div><div class="line">if (mv != null &amp;&amp; !name.equals(&quot;&lt;init&gt;&quot;)) &#123;</div><div class="line">  mv = new RemoveNopAdapter(mv);</div><div class="line">&#125;</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>在这种情况下，适配链对于构造函数来说会短一点。<br>与之相反，构造函数的调用链也可以更长，当几个方法适配链在<strong>visitMethod</strong>方法中被一起创建。<br>甚至方法适配链可以于类适配链拥有不同的拓扑结构。<br>例如类适配链可以是线性的，方法适配链可以具有多个分支结构：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> MethodVisitor <span class="title">visitMethod</span><span class="params">(<span class="keyword">int</span> access, String name,</span></span></div><div class="line">    String desc, String signature, String[] exceptions) &#123;</div><div class="line">  MethodVisitor mv1, mv2;</div><div class="line">  mv1 = cv.visitMethod(access, name, desc, signature, exceptions);</div><div class="line">  mv2 = cv.visitMethod(access, <span class="string">"_"</span> + name, desc, signature, exceptions);</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> MultiMethodAdapter(mv1, mv2);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在，你已经知道在一个类适配器中，多个方法适配如何使用和结合，接下来让我们实现一些比<strong>‘RemoveNopAdapter’</strong>更加有趣的适配器。</p>
<h4 id="3-2-4-无状态转换-Stateless-transformations"><a href="#3-2-4-无状态转换-Stateless-transformations" class="headerlink" title="3.2.4 无状态转换 Stateless transformations"></a>3.2.4 无状态转换 Stateless transformations</h4><p>假设我们要检测一个程序中每个类的耗时，我们需要在每一个类中加入一个静态的timer属性，我们只需要把每一个方法的执行时间加在该属性上。<br>换句话说，我们想要将一个类C：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">m</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    Thread.sleep(<span class="number">100</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>转换成：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> timer;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">m</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    timer -= System.currentTimeMillis();</div><div class="line">    Thread.sleep(<span class="number">100</span>);</div><div class="line">    timer += System.currentTimeMillis();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>为了有一个如何通过ASM实现该转换的思路，我们可以编译这两个类，使用<strong>‘TraceClassVisitor’</strong>输出两个编译类的字节码，并进行比较（可以使用Textifier，或者使用ASMifier）。<br>下面是使用默认的Textifier输出，注意不同的部分（粗体）：</p>
<blockquote>
<p><strong>GETSTATIC C.timer : J</strong><br><strong>INVOKESTATIC java/lang/System.currentTimeMillis()J</strong><br><strong>LSUB</strong><br><strong>PUTSTATIC C.timer : J</strong><br>LDC 100<br>INVOKESTATIC java/lang/Thread.sleep(J)V<br><strong>GETSTATIC C.timer : J</strong><br><strong>INVOKESTATIC java/lang/System.currentTimeMillis()J</strong><br><strong>LADD</strong><br><strong>PUTSTATIC C.timer : J</strong><br>RETURN<br>MAXSTACK = <strong>4</strong><br>MAXLOCALS = 1</p>
</blockquote>
<p>可以看到，我们需要在方法的开始增加四条指令，在<strong>‘return’</strong>指令前增加另外四条指令。<br>同样也需要更改操作栈的最大值。方法代码的开始使用<strong>visitCode</strong>方法访问。<br>因此我们可以在方法适配器中重写该方法，增加开始的四条指令：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitCode</span><span class="params">()</span></span>&#123;</div><div class="line">  mv.visitCode();</div><div class="line">  mv.visitFieldInsn(GETSTATIC,owner,<span class="string">"timer"</span>,<span class="string">"J"</span>);</div><div class="line">  mv.visitMethodInsn(INVOKESTATIC,<span class="string">"java/lang/System"</span>,<span class="string">"currentTimeMillis"</span>,<span class="string">"()J"</span>);</div><div class="line">  mv.visitInsn(LSUB);</div><div class="line">  mv.visitFieldInsn(PUTSTATIC,owner,<span class="string">"timer"</span>,<span class="string">"J"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>owner</strong>参数必须设置成需要改造类的名字。<br>现在我们需要在<strong>RETURN</strong>指令前插入四条指令，但是也可能是在<strong><em>x</em>RETURN</strong>指令或者<strong>ATHROW</strong>指令前，这些指令都是结束方法执行的指令。<br>这些指令需要参数，因此可以使用<strong>visitInsn</strong>方法访问。<br>我们可以覆盖该方法来增加四条指令：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitInsn</span><span class="params">(<span class="keyword">int</span> opcode)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> ((opcode &gt;= IRETURN &amp;&amp; opcode &lt;= RETURN) || opcode == ATHROW) &#123;</div><div class="line">    mv.visitFieldInsn(GETSTATIC, owner, <span class="string">"timer"</span>, <span class="string">"J"</span>);</div><div class="line">    mv.visitMethodInsn(INVOKESTATIC, <span class="string">"java/lang/System"</span>,</div><div class="line">    <span class="string">"currentTimeMillis"</span>, <span class="string">"()J"</span>);</div><div class="line">    mv.visitInsn(LADD);</div><div class="line">    mv.visitFieldInsn(PUTSTATIC, owner, <span class="string">"timer"</span>, <span class="string">"J"</span>);</div><div class="line">  &#125;</div><div class="line">  mv.visitInsn(opcode);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后我们需要更操作栈的最大值。<br>变更后的指令集中，我们会压入栈中两个long型值，所有我们需要在操作栈上有四个槽。<br>在方法开始，操作栈会初始换成空的，因此方法开始时新增的四条指令需要栈的大小是4.<br>同时我们也知道，插入的四个指令在执行完后，操作栈的空间大小会恢复空（因为这些指令执行后，会弹出所有压入栈中的值）。<br>总结一下，如果原代码需要栈的大小是<strong>s</strong>，那么改造后需要的最大栈空间是<strong>‘max(4,s)’</strong>，即取变量<strong>‘s’</strong>和常量<strong>‘4’</strong>的最大值。<br>不幸的，我们还在方法结束前增加了四条指令，我们需要知道在这四条指令执行前，操作栈的大小。<br>我们只知道，该值小于等于<strong>‘s’</strong>。因此我们可以总结出来，插入这四条指令后，我们需要将栈的空间大小设置成<strong>‘s+4’</strong>。<br>这种最坏的情况在实践中几乎和很少发生：通常的编译器，在执行返回指令前操作栈中仅保留返回值，即需要的栈空间大小可能是0、1，最多是2。<br>但是如果我们想要处理所有可能发生的情况，我们就必须作最坏的打算<sup>2</sup>。</p>
<blockquote>
<p>2：最坏的情况<br>给出最佳的操作栈不是必要的。给出任何大于等于最佳操作栈大小的值就可以，尽快这样会浪费线程执行栈的内存。</p>
</blockquote>
<p>我们必须重写<strong>‘visitMaxs’</strong>方法，如下所示：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitMaxs</span><span class="params">(<span class="keyword">int</span> maxStack, <span class="keyword">int</span> maxLocals)</span> </span>&#123;</div><div class="line">  mv.visitMaxs(maxStack + <span class="number">4</span>, maxLocals);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当然也可以不用操心最大操作栈大小，可以依靠<strong>‘COMPUTE_MAXS’</strong>参数，使用该参数后会计算出最佳的操作栈大小，而不是最坏情况的值。<br>对于这么一个简单的转换，没有必要花费大力气来手动更新<strong>‘maxStack’</strong>。</p>
<p>现在一个有趣的问题是：栈哈希帧怎么办？<br>源码中不包含任何帧，也没有任何相转换的代码，但这是由于我们代码使用了特殊的代码么？<br>是否在某些特定的情境下这些帧会被更新？<br>答案是否定的，因为：</p>
<ol>
<li>插入的指令离不开操作栈的变化。</li>
<li>插入的代码不能包含跳转指令。</li>
<li>跳转指令，更确切的讲，源码的控制流图没有改变。<br>这说明原始的帧没有变化，由于插入的新代码没有新增帧，压缩的原始帧也不需要修改。</li>
</ol>
<p>现在我们可以把所有的元素组合到一起，并于<strong>‘ClassVisitor’</strong>和<strong>‘MethodVisitor</strong>的子类相关联：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AddTimerAdapter</span> <span class="keyword">extends</span> <span class="title">ClassVisitor</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> String owner;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> isInterface;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">AddTimerAdapter</span><span class="params">(ClassVisitor cv)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(ASM4, cv);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(<span class="keyword">int</span> version, <span class="keyword">int</span> access, String name, String signature, String superName, String[] interfaces)</span> </span>&#123;</div><div class="line">    cv.visit(version, access, name, signature, superName, interfaces);</div><div class="line">    owner = name;</div><div class="line">    isInterface = (access &amp; ACC_INTERFACE) != <span class="number">0</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> MethodVisitor <span class="title">visitMethod</span><span class="params">(<span class="keyword">int</span> access, String name, String desc, String signature, String[] exceptions)</span> </span>&#123;</div><div class="line">    MethodVisitor mv = cv.visitMethod(access, name, desc, signature, exceptions);</div><div class="line">    <span class="keyword">if</span> (!isInterface &amp;&amp; mv != <span class="keyword">null</span> &amp;&amp; !name.equals(<span class="string">"&lt;init&gt;"</span>)) &#123;</div><div class="line">      mv = <span class="keyword">new</span> AddTimerMethodAdapter(mv);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> mv;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitEnd</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!isInterface) &#123;</div><div class="line">      FieldVisitor fv = cv.visitField(ACC_PUBLIC + ACC_STATIC, <span class="string">"timer"</span>, <span class="string">"J"</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">      <span class="keyword">if</span> (fv != <span class="keyword">null</span>) &#123;</div><div class="line">        fv.visitEnd();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    cv.visitEnd();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">AddTimerMethodAdapter</span> <span class="keyword">extends</span> <span class="title">MethodVisitor</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AddTimerMethodAdapter</span><span class="params">(MethodVisitor mv)</span> </span>&#123;</div><div class="line">      <span class="keyword">super</span>(ASM4, mv);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitCode</span><span class="params">()</span> </span>&#123;</div><div class="line">      mv.visitCode();</div><div class="line">      mv.visitFieldInsn(GETSTATIC, owner, <span class="string">"timer"</span>, <span class="string">"J"</span>);</div><div class="line">      mv.visitMethodInsn(INVOKESTATIC, <span class="string">"java/lang/System"</span>, <span class="string">"currentTimeMillis"</span>, <span class="string">"()J"</span>);</div><div class="line">      mv.visitInsn(LSUB);</div><div class="line">      mv.visitFieldInsn(PUTSTATIC, owner, <span class="string">"timer"</span>, <span class="string">"J"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitInsn</span><span class="params">(<span class="keyword">int</span> opcode)</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> ((opcode &gt;= IRETURN &amp;&amp; opcode &lt;= RETURN) || opcode == ATHROW) &#123;</div><div class="line">        mv.visitFieldInsn(GETSTATIC, owner, <span class="string">"timer"</span>, <span class="string">"J"</span>);</div><div class="line">        mv.visitMethodInsn(INVOKESTATIC, <span class="string">"java/lang/System"</span>, <span class="string">"currentTimeMillis"</span>, <span class="string">"()J"</span>);</div><div class="line">        mv.visitInsn(LADD);</div><div class="line">        mv.visitFieldInsn(PUTSTATIC, owner, <span class="string">"timer"</span>, <span class="string">"J"</span>);</div><div class="line">      &#125;</div><div class="line">      mv.visitInsn(opcode);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitMaxs</span><span class="params">(<span class="keyword">int</span> maxStack, <span class="keyword">int</span> maxLocals)</span> </span>&#123;</div><div class="line">      mv.visitMaxs(maxStack + <span class="number">4</span>, maxLocals);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>类适配器用于实例化方法适配器（排除构造方法），但也在类中加入了一个<strong>timer</strong>属性，通过存储在类中的该属性名，方法适配器可以访问该属性。</p>
<h4 id="3-2-5-有状态转换-Statefull-transformations"><a href="#3-2-5-有状态转换-Statefull-transformations" class="headerlink" title="3.2.5. 有状态转换 Statefull transformations"></a>3.2.5. 有状态转换 Statefull transformations</h4><p>在上一节中的讲述的转换是本地的，并不依赖在当前转换前已经访问的指令集：比如在方法开始时插入的代码都是相同的，与之类似的，代码在每个<strong>‘RETURN’</strong>指令前插入的，也都是相同。<br>像这样的转换被成为无状态的转换。这种转换很容易使先，只有简单的转换并验证该属性。<br>更负责的转换需要在本次转换前，存储某些已被访问过的指令的状态。<br>例如，考虑一个转换：移除所有出现的指令序列<strong>‘ICONST_0 IADD’</strong>，该指令序列产生的效果是数值加0。<br>显然，当一个<strong>‘IADD’</strong>指令被访问时，当且仅当上一个被访问的指令是<strong>‘ICONST_0’</strong>时，移除这两个指令。</p>
<p>这个转换需要在方法适配器中存储状态信息。<br>出于这个原因，这种转换被称为有状态转换。<br>让我们更加仔细的看一下这个例子。当一个<strong>‘ICONST_0’</strong>指令被访问时，如果下一条指令是IADD，那么该条指令必须被移除。<br>问题是下一条指令还不知道是什么。<br>解决方法是推迟访问该指令到一下条指令：当访问到下一个指令时，如果指令是<strong>‘IADD’</strong>，那么移除这两个指令，否则访问<strong>‘ICONST_0’</strong>指令和当前指令。<br>为了实现删除或替换某些指令序列，可以很方便的引入一个<strong>‘MethodVisitor’</strong>的子类，使用子类的<strong>‘visitXxx Insn’</strong>方法调用通用的<strong>‘visitInsn’</strong>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">PatternMethodAdapter</span> <span class="keyword">extends</span> <span class="title">MethodVisitor</span> </span>&#123;</div><div class="line">  <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> SEEN_NOTHING = <span class="number">0</span>;</div><div class="line">  <span class="keyword">protected</span> <span class="keyword">int</span> state;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">PatternMethodAdapter</span><span class="params">(<span class="keyword">int</span> api, MethodVisitor mv)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(api, mv);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Overrid</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitInsn</span><span class="params">(<span class="keyword">int</span> opcode)</span> </span>&#123;</div><div class="line">    visitInsn();</div><div class="line">    mv.visitInsn(opcode);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitIntInsn</span><span class="params">(<span class="keyword">int</span> opcode, <span class="keyword">int</span> operand)</span> </span>&#123;</div><div class="line">    visitInsn();</div><div class="line">    mv.visitIntInsn(opcode, operand);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  ...</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">visitInsn</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后，上面的转换可以被这样实现：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoveAddZeroAdapter</span> <span class="keyword">extends</span> <span class="title">PatternMethodAdapter</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> SEEN_ICONST_0 = <span class="number">1</span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">RemoveAddZeroAdapter</span><span class="params">(MethodVisitor mv)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(ASM4, mv);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitInsn</span><span class="params">(<span class="keyword">int</span> opcode)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (state == SEEN_ICONST_0) &#123;</div><div class="line">      <span class="keyword">if</span> (opcode == IADD) &#123;</div><div class="line">        state = SEEN_NOTHING;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    visitInsn();</div><div class="line">    <span class="keyword">if</span> (opcode == ICONST_0) &#123;</div><div class="line">      state = SEEN_ICONST_0;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    mv.visitInsn(opcode);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">visitInsn</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (state == SEEN_ICONST_0) &#123;</div><div class="line">      mv.visitInsn(ICONST_0);</div><div class="line">    &#125;</div><div class="line">    state = SEEN_NOTHING;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>‘visitInsn(int)’</strong>方法首先测试需要移除的指令序列是否被检测到了。<br>在这种情况中，重新初始化状态后就立即返回，产生的效果是移除指令集序列。<br>在其他情况下，调用通用的<strong>‘visitInsn(int)’</strong>方法，发出一个<strong>‘ICONST_0’</strong>指令，如果这个是最后被访问的指令。<br>然后，如果当前的指令是<strong>‘ICONST_0’</strong>，就会记录这种状态并且返回，为了推迟关于该指令的决策。<br>在所有其他情况下，当前指令被转发给下一个访问器。</p>
<h5 id="标签和帧：Labels-and-frames"><a href="#标签和帧：Labels-and-frames" class="headerlink" title="标签和帧：Labels and frames"></a>标签和帧：Labels and frames</h5><p>在上一节中，我们看到标签和帧会在他们所关联的指令前即将访问前被访问。<br>换句话说他们作为指令集同时被访问，尽管他们本身不是指令。<br>这会对检测指令集序列的转换产生影响，但这种影响实际上是一个优点。<br>事实上，如果我们移除的一个指令是一个跳转指令的目标，那么会发生什么？<br>如果某些指令可能会跳转到<strong>‘ICONST_0’</strong>，这意味着有一个标签指派该指令。<br>在移除这两个指令后，这个标签会指派给已被移除<strong>‘IADD’</strong>指令的后一个指令，这是我们想要的。<br>但某些指令可能跳转到<strong>‘IADD’</strong>指令，我们就不能移除这个指令序列（我们不能保证，在跳转指令前有一个<strong>‘0’</strong>值被压入到栈上）。。<br>庆幸的是，在本示例中，在<strong>‘ICONST_0’</strong>指令和<strong>‘IADD’</strong>指令中间肯定会有一个标签，可以很容易检测到。</p>
<p>原因和栈哈希帧相同：如果在两个指令中间有一个栈哈希帧被访问，我们就不能移除这两个指令。<br>在这两种情况下，可以在模式匹配算法中，将标签和帧作为指令处理。<br>这些可以在<strong>‘PatternMethodAdapter’</strong>中实现（注意：visitMaxs也会调用通用的<strong>‘visitInsn’</strong>方法，用于处理将一个方法的结束当作序列的前缀，这种情况必须被检测到）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">PatternMethodAdapter</span> <span class="keyword">extends</span> <span class="title">MethodVisitor</span> </span>&#123;</div><div class="line">  ...</div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitFrame</span><span class="params">(<span class="keyword">int</span> type, <span class="keyword">int</span> nLocal, Object[] local,</span></span></div><div class="line">    <span class="keyword">int</span> nStack, Object[] stack) &#123;</div><div class="line">    visitInsn();</div><div class="line">    mv.visitFrame(type, nLocal, local, nStack, stack);</div><div class="line">  &#125;</div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitLabel</span><span class="params">(Label label)</span> </span>&#123;</div><div class="line">    visitInsn();</div><div class="line">    mv.visitLabel(label);</div><div class="line">  &#125;</div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitMaxs</span><span class="params">(<span class="keyword">int</span> maxStack, <span class="keyword">int</span> maxLocals)</span> </span>&#123;</div><div class="line">    visitInsn();</div><div class="line">    mv.visitMaxs(maxStack, maxLocals);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在下一节我们会看到，一个编译后的方法可能会包含源文件的行号，用于实例化异常的栈跟踪信息。<br>这种信息使用<strong>‘visitLineNumber’</strong>方法访问，和调用指令同时掉用。<br>在两个指令序列的中间仍然存在行号，这对转换和移除指令序列没有任何影响。<br>因此解决方案是在匹配算法中完全忽视他们。</p>
<h5 id="一个更加复杂的示例"><a href="#一个更加复杂的示例" class="headerlink" title="一个更加复杂的示例"></a>一个更加复杂的示例</h5><p>上一个示例可以很容易的延用到更加复杂的指令序列。<br>设想一个转换，移除自己赋值给自己的指令，一般是由错误书写，比如<strong>‘f==f’</strong>；或者<strong>‘ALOAD 0 ALOAD 0 GETFIELD f PUTFIELD f’</strong>这样的字节码。<br>在实现这个转换之前，最好先设计一个状态机来识别这种序列（参考图表 3.6）。</p>
<p><img src="/img/program/asm/ASM-3.2.5-56-3.6.png" alt="图表 3.6 指令序列&#39;ALOAD 0 ALOAD 0 GETFIELD f PUTFIELD f&#39;的状态机 "></p>
<p>每个过渡都标有一个条件（当前指令的值）和一个动作（一个必须被发送的指令序列）。<br>例如，如果当前的指令不是<strong>‘ALOAD 0’</strong>会发生从<strong>‘S1’</strong>到<strong>‘S0’</strong>的过渡。<br>在这种情况下访问<strong>‘ALOAD 0’</strong>指令，能到达该状态，会被发送。<br>需要注意<strong>‘S2’</strong>到本身的过度：这个过度发生在有三个以上的连续<strong>‘ALOAD 0’</strong>指令被访问，就将两个<strong>‘ALOAD 0’</strong>之后访问的<strong>‘ALOAD 0’</strong>指令发送出去。<br>只要状态机被发现了，编写相应的方法适配器是很简单的（8个swtich case对应了图表中的8种过渡）：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RemoveGetFieldPutFieldAdapter</span> <span class="keyword">extends</span> <span class="title">PatternMethodAdapter</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> SEEN_ALOAD_0 = <span class="number">1</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> SEEN_ALOAD_0ALOAD_0 = <span class="number">2</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> SEEN_ALOAD_0ALOAD_0GETFIELD = <span class="number">3</span>;</div><div class="line">  <span class="keyword">private</span> String fieldOwner;</div><div class="line">  <span class="keyword">private</span> String fieldName;</div><div class="line">  <span class="keyword">private</span> String fieldDesc;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">RemoveGetFieldPutFieldAdapter</span><span class="params">(MethodVisitor mv)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(mv);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitVarInsn</span><span class="params">(<span class="keyword">int</span> opcode, <span class="keyword">int</span> var)</span> </span>&#123;</div><div class="line">    <span class="keyword">switch</span> (state) &#123;</div><div class="line">    <span class="keyword">case</span> SEEN_NOTHING: <span class="comment">// S0 -&gt; S1</span></div><div class="line">      <span class="keyword">if</span> (opcode == ALOAD &amp;&amp; var == <span class="number">0</span>) &#123;</div><div class="line">        state = SEEN_ALOAD_0;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> SEEN_ALOAD_0: <span class="comment">// S1 -&gt; S2</span></div><div class="line">      <span class="keyword">if</span> (opcode == ALOAD &amp;&amp; var == <span class="number">0</span>) &#123;</div><div class="line">        state = SEEN_ALOAD_0ALOAD_0;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> SEEN_ALOAD_0ALOAD_0: <span class="comment">// S2 -&gt; S2</span></div><div class="line">      <span class="keyword">if</span> (opcode == ALOAD &amp;&amp; var == <span class="number">0</span>) &#123;</div><div class="line">        mv.visitVarInsn(ALOAD, <span class="number">0</span>);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    visitInsn();</div><div class="line">    mv.visitVarInsn(opcode, var);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitFieldInsn</span><span class="params">(<span class="keyword">int</span> opcode, String owner, String name, String desc)</span> </span>&#123;</div><div class="line">    <span class="keyword">switch</span> (state) &#123;</div><div class="line">    <span class="keyword">case</span> SEEN_ALOAD_0ALOAD_0: <span class="comment">// S2 -&gt; S3</span></div><div class="line">      <span class="keyword">if</span> (opcode == GETFIELD) &#123;</div><div class="line">        state = SEEN_ALOAD_0ALOAD_0GETFIELD;</div><div class="line">        fieldOwner = owner;</div><div class="line">        fieldName = name;</div><div class="line">        fieldDesc = desc;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> SEEN_ALOAD_0ALOAD_0GETFIELD: <span class="comment">// S3 -&gt; S0</span></div><div class="line">      <span class="keyword">if</span> (opcode == PUTFIELD &amp;&amp; name.equals(fieldName)) &#123;</div><div class="line">        state = SEEN_NOTHING;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    visitInsn();</div><div class="line">    mv.visitFieldInsn(opcode, owner, name, desc);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">visitInsn</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">switch</span> (state) &#123;</div><div class="line">    <span class="keyword">case</span> SEEN_ALOAD_0: <span class="comment">// S1 -&gt; S0</span></div><div class="line">      mv.visitVarInsn(ALOAD, <span class="number">0</span>);</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> SEEN_ALOAD_0ALOAD_0: <span class="comment">// S2 -&gt; S0</span></div><div class="line">      mv.visitVarInsn(ALOAD, <span class="number">0</span>);</div><div class="line">      mv.visitVarInsn(ALOAD, <span class="number">0</span>);</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> SEEN_ALOAD_0ALOAD_0GETFIELD: <span class="comment">// S3 -&gt; S0</span></div><div class="line">      mv.visitVarInsn(ALOAD, <span class="number">0</span>);</div><div class="line">      mv.visitVarInsn(ALOAD, <span class="number">0</span>);</div><div class="line">      mv.visitFieldInsn(GETFIELD, fieldOwner, fieldName, fieldDesc);</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    state = SEEN_NOTHING;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注意，出于和3.2.4节中<strong>‘AddTimerAdapter’</strong>示例中相同的原因，在本节中有状态的转换不需要改变栈哈希帧：改造后原本的帧仍然有效。<br>甚至我们不需要改变本地变量和操作栈的大小。最后必须要声明的是，有状态的转换不仅限于检测和改造指令序列。<br>很多其他类型的转换也是有状态的。在这种情况下，在下一节将介绍方法适配器。</p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Program/">Program</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Java/">Java</a><a href="/tags/Manual/">Manual</a><a href="/tags/ASM/">ASM</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	<div class="share-jiathis">
	  
<div class="jiathis_style_24x24">
	<a class="jiathis_button_tsina"></a>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_renren"></a>
	<a class="jiathis_button_qzone"></a>
	<a class="jiathis_button_googleplus"></a>
	<a class="jiathis_button_douban"></a>
	<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
    var jiathis_config={
    data_track_clickback:true,
    sm:"copy,renren,cqq",
    pic:"",
    summary:"",
     ralateuid:{"tsina":"1395925565"},hideMore:false}
    
  </script> 
<script type="text/javascript" src="//v3.jiathis.com/code/jia.js?uid=
2076153" charset="utf-8"></script>      

	 </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2016/09/28/asm/4/Manual_ASM_3.3_Method_Tools/" title="3.3 ASM-方法-工具类">
  <strong>上一篇：</strong><br/>
  <span>
  3.3 ASM-方法-工具类</span>
</a>
</div>


<div class="next">
<a href="/2016/09/21/asm/4/Manual_ASM_3.1_Method_Structure/"  title="3.1 ASM-方法-结构">
 <strong>下一篇：</strong><br/> 
 <span>3.1 ASM-方法-结构
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2016/09/26/asm/4/Manual_ASM_3.2_Method_Interfaces_And_Components/" data-title="3.2 ASM-方法-接口和组件" data-url="http://www.innereye.cn/2016/09/26/asm/4/Manual_ASM_3.2_Method_Interfaces_And_Components/"></div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-接口和组件"><span class="toc-number">1.</span> <span class="toc-text">3.2 接口和组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-介绍"><span class="toc-number">1.1.</span> <span class="toc-text">3.2.1 介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-生成方法-Generating-methods"><span class="toc-number">1.2.</span> <span class="toc-text">3.2.2 生成方法 Generating methods</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-3-改造方法-Transforming-methods"><span class="toc-number">1.3.</span> <span class="toc-text">3.2.3. 改造方法 Transforming methods</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-4-无状态转换-Stateless-transformations"><span class="toc-number">1.4.</span> <span class="toc-text">3.2.4 无状态转换 Stateless transformations</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-5-有状态转换-Statefull-transformations"><span class="toc-number">1.5.</span> <span class="toc-text">3.2.5. 有状态转换 Statefull transformations</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#标签和帧：Labels-and-frames"><span class="toc-number">1.5.1.</span> <span class="toc-text">标签和帧：Labels and frames</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#一个更加复杂的示例"><span class="toc-number">1.5.2.</span> <span class="toc-text">一个更加复杂的示例</span></a></li></ol></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="baifan" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>
  </div>



  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Cmd/" title="Cmd">Cmd<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Database/" title="Database">Database<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Program/Spring/Manual/" title="Manual">Manual<sup>1</sup></a></li>
		  
		
		  
		
		  
			<li><a href="/categories/Program/" title="Program">Program<sup>23</sup></a></li>
		  
		
		  
			<li><a href="/categories/Quality/" title="Quality">Quality<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Redis/" title="Redis">Redis<sup>1</sup></a></li>
		  
		
		  
		
		  
			<li><a href="/categories/Server/" title="Server">Server<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Program/Spring/" title="Spring">Spring<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Tool/" title="Tool">Tool<sup>5</sup></a></li>
		  
		
		  
		
		  
			<li><a href="/categories/业余/" title="业余">业余<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/互联网/" title="互联网">互联网<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/效率/" title="效率">效率<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/算法/" title="算法">算法<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/管理/" title="管理">管理<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/运营/" title="运营">运营<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Java/" title="Java">Java<sup>29</sup></a></li>
			
		
			
				<li><a href="/tags/Manual/" title="Manual">Manual<sup>22</sup></a></li>
			
		
			
				<li><a href="/tags/ASM/" title="ASM">ASM<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/Debug/" title="Debug">Debug<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Tool/" title="Tool">Tool<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Spring/" title="Spring">Spring<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Gradle/" title="Gradle">Gradle<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/团队/" title="团队">团队<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/效率/" title="效率">效率<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Maven/" title="Maven">Maven<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/格言/" title="格言">格言<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/数据库/" title="数据库">数据库<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Log/" title="Log">Log<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Sonar/" title="Sonar">Sonar<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Style/" title="Style">Style<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Apache/" title="Apache">Apache<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/English/" title="English">English<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Static/" title="Static">Static<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/趋势/" title="趋势">趋势<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://wsysisibeibei.blog.163.com" target="_blank" title="程序员网站">渔网</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark">Jark</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="undefined" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=1395925565&verifier=7a6db67f&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m BaiFan in Github. <br/>
			Sometimes, the perfect one for you is the one you least expect. </p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/sisibeibei" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/baifan" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		<a href="https://www.linkedin.com/in/sisibeibei" target="_blank" class="icon-linkedin" title="linkedin"></a>
		
		
		
		
		
		<a href="mailto:wsysisibeibei@gmail.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		
				<div class="cc-license">
          <a href="http://creativecommons.org/licenses/by-nd/4.0" class="cc-opacity" target="_blank">
            <img src="/img/cc-by-nd.svg" alt="Creative Commons" />
          </a>
<!-- Analytics Begin -->





<script type="text/javascript">
var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(decodeURIComponent("%3Cspan id='cnzz_stat_icon_1256965070'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s11.cnzz.com/z_stat.php%3Fid%3D1256965070%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
</script>

<!-- Analytics End -->
        </div>
    

	<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">HEXO</a> and Theme by <a
				href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a>
		© 2017 |
		UV : <span id="busuanzi_value_site_uv"></span> |
		PV : <span id="busuanzi_value_site_pv"></span>
	</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>




<script type="text/javascript">
  var duoshuoQuery = {short_name:"baifan"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>


<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->
<!-- swiftype_search Begin -->

<script>
    (function (w, d, t, u, n, s, e) {
        w['SwiftypeObject'] = n;
        w[n] = w[n] || function () {
                    (w[n].q = w[n].q || []).push(arguments);
                };
        s = d.createElement(t);
        e = d.getElementsByTagName(t)[0];
        s.async = 1;
        s.src = u;
        e.parentNode.insertBefore(s, e);
    })(window, document, 'script', '//s.swiftypecdn.com/install/v2/st.js', '_st');

    _st('install', '9GijbT6BWsby7ZU5KL8e', '2.0.0');

</script>

<!-- swiftype_search End -->

  </body>
</html>
